<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新年快乐！</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            overflow: hidden;
            font-family: "Microsoft YaHei", "PingFang SC", "Heiti SC", sans-serif;
            color: white;
        }
        
        /* 姓名输入页面样式 */
        #nameInputPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            transition: opacity 0.8s ease;
        }
        
        .name-container {
            text-align: center;
            padding: 40px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            border: 2px solid #ffdd00;
            box-shadow: 0 0 40px rgba(255, 221, 0, 0.5);
            max-width: 90%;
            width: 500px;
            backdrop-filter: blur(10px);
        }
        
        .name-title {
            font-size: 3.5rem;
            font-weight: 900;
            color: #ffdd00;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 221, 0, 0.8);
        }
        
        .name-subtitle {
            font-size: 1.2rem;
            margin-bottom: 30px;
            color: #fff;
            opacity: 0.9;
        }
        
        .name-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #ffdd00;
            border-radius: 10px;
            color: #fff;
            text-align: center;
            margin-bottom: 25px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .name-input:focus {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(255, 221, 0, 0.5);
        }
        
        .name-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .name-submit {
            padding: 15px 40px;
            font-size: 1.3rem;
            font-weight: bold;
            background: linear-gradient(135deg, #ffdd00 0%, #ff9900 100%);
            border: none;
            border-radius: 10px;
            color: #000;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 221, 0, 0.5);
        }
        
        .name-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 30px rgba(255, 221, 0, 0.8);
        }
        
        .name-submit:active {
            transform: translateY(0);
        }
        
        .name-hint {
            margin-top: 20px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* 烟花页面样式 */
        #fireworksPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }
        
        #fireworksCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .text-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 2;
            pointer-events: none;
        }
        
        .special-text {
            font-size: 8vw;
            font-weight: 900;
            color: #ffdd00;
            text-shadow: 
                0 0 20px #ff9900,
                0 0 40px #ff5500,
                0 0 60px #ff0000;
            text-align: center;
            animation: textGlow 1.5s infinite alternate;
            line-height: 1.2;
            padding: 0;
            margin: 0;
            display: block;
            transition: opacity 1s ease;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            opacity: 0;
            white-space: nowrap;
        }
        
        .final-text {
            font-size: 10vw;
            font-weight: 900;
            color: #ffdd00;
            text-shadow: 0 0 5px #ff9900;
            text-align: center;
            line-height: 1.2;
            padding: 0;
            margin: 0;
            display: block;
            transition: opacity 1s ease;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 95%;
            opacity: 0;
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            letter-spacing: 1px;
            word-wrap: break-word;
            word-break: break-all;
        }
        
        .special-mode-text {
            font-size: 5vw;
            font-weight: 700;
            color: #ffdd00;
            text-shadow: 
                0 0 15px #ff9900,
                0 0 30px #ff5500,
                0 0 45px #ff0000;
            text-align: center;
            animation: textGlow 2s infinite alternate;
            line-height: 1.3;
            padding: 0;
            margin: 0;
            display: block;
            transition: opacity 1s ease;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            opacity: 0;
            white-space: normal;
        }
        
        @keyframes textGlow {
            0% {
                text-shadow: 
                    0 0 40px #ff9900,
                    0 0 80px #ff5500,
                    0 0 120px #ff0000,
                    0 0 160px #ff0000;
            }
            50% {
                text-shadow: 
                    0 0 60px #ffdd00,
                    0 0 120px #ff9900,
                    0 0 180px #ff5500,
                    0 0 240px #ff0000;
            }
            100% {
                text-shadow: 
                    0 0 80px #ffff00,
                    0 0 160px #ffdd00,
                    0 0 240px #ff9900,
                    0 0 320px #ff5500;
            }
        }
        
        @media (max-width: 768px) {
            .name-container {
                padding: 30px 20px;
                width: 90%;
            }
            
            .name-title {
                font-size: 2.5rem;
            }
            
            .name-input {
                font-size: 1.2rem;
                padding: 12px 15px;
            }
            
            .name-submit {
                padding: 12px 30px;
                font-size: 1.1rem;
            }
            
            .special-text {
                font-size: 10vw;
                white-space: normal;
                max-width: 90%;
            }
            
            .final-text {
                font-size: 12vw;
                white-space: normal;
                max-width: 95%;
                line-height: 1.1;
                letter-spacing: 0.5px;
                text-shadow: 0 0 3px #ff9900;
            }
            
            .special-mode-text {
                font-size: 6vw;
            }
        }
        
        @media (max-height: 500px) {
            .text-container {
                align-items: flex-start;
                padding-top: 10vh;
            }
            .special-text {
                font-size: 8vh;
            }
            .final-text {
                font-size: 10vh;
                text-shadow: 0 0 4px #ff9900;
            }
            .special-mode-text {
                font-size: 5vh;
            }
        }
        
        @media (max-width: 480px) {
            .special-text {
                font-size: 12vw;
            }
            
            .final-text {
                font-size: 14vw;
                white-space: normal;
                max-width: 98%;
                text-shadow: 0 0 2px #ff9900;
            }
            
            .special-mode-text {
                font-size: 7vw;
            }
        }
        
        @media (min-width: 2000px) {
            .special-text {
                font-size: 6vw;
            }
            .final-text {
                font-size: 8vw;
                text-shadow: 0 0 6px #ff9900;
            }
            .special-mode-text {
                font-size: 4vw;
            }
        }
        
        @media (max-width: 1024px) and (min-width: 769px) {
            .final-text {
                font-size: 9vw;
                text-shadow: 0 0 4px #ff9900;
            }
        }
    </style>
</head>
<body>
    <!-- 姓名输入页面 -->
    <div id="nameInputPage">
        <div class="name-container">
            <div class="name-title">新年快乐！</div>
            <div class="name-subtitle">请输入您的名字，开始烟花秀</div>
            <input type="text" id="userName" class="name-input" placeholder="请输入您的名字" maxlength="20" autocomplete="off">
            <button id="submitName" class="name-submit">开始烟花秀</button>
            <div class="name-hint">点击按钮或按回车键开始</div>
        </div>
    </div>
    
    <!-- 烟花页面 -->
    <div id="fireworksPage">
        <canvas id="fireworksCanvas"></canvas>
        <div class="text-container">
            <div class="special-text" id="specialText1">猜猜神秘大奖是什么？</div>
            <div class="special-text" id="specialText2">没错就是我的新年祝福哦</div>
            <div class="final-text" id="finalText"></div>
            <div class="special-mode-text" id="specialModeText">吹云骨，贺新春！飞絮滚轻尘，新岁愿你的玉玉如笛声迅捷，真气如长虹贯日，燕云江湖，唯你闪耀！</div>
        </div>
        
        <!-- 背景音乐 -->
        <audio id="bgMusic" loop>
            <source src="http://music.163.com/song/media/outer/url?id=1413464902.mp3" type="audio/mpeg">
            您的浏览器不支持音频元素
        </audio>
    </div>

    <script>
        const nameInputPage = document.getElementById('nameInputPage');
        const fireworksPage = document.getElementById('fireworksPage');
        const userNameInput = document.getElementById('userName');
        const submitNameBtn = document.getElementById('submitName');
        const specialText1 = document.getElementById('specialText1');
        const specialText2 = document.getElementById('specialText2');
        const finalText = document.getElementById('finalText');
        const specialModeText = document.getElementById('specialModeText');
        
        userNameInput.focus();
        
        function formatGreetingText(userName) {
            if (!userName || userName.trim() === '') {
                return '朋友，新年快乐！';
            }
            
            let nameLength = 0;
            for (let i = 0; i < userName.length; i++) {
                const charCode = userName.charCodeAt(i);
                if (charCode >= 0x4E00 && charCode <= 0x9FFF) {
                    nameLength += 2;
                } else {
                    nameLength += 1;
                }
            }
            
            if (nameLength > 6) {
                return userName + '，<br>新年快乐！';
            } else {
                return userName + '，新年快乐！';
            }
        }
        
        function startSpecialEffect() {
            console.log("阶段1：显示'猜猜神秘大奖是什么？'（3秒）");
            specialText1.style.opacity = '1';
            
            setTimeout(() => {
                console.log("阶段1结束：'猜猜神秘大奖是什么？'淡出");
                specialText1.style.opacity = '0';
                
                setTimeout(() => {
                    console.log("阶段2：显示'没错就是我的新年祝福哦'（3秒）");
                    specialText2.style.opacity = '1';
                    
                    setTimeout(() => {
                        console.log("阶段2结束：'没错就是我的新年祝福哦'淡出");
                        specialText2.style.opacity = '0';
                        
                        setTimeout(() => {
                            console.log("阶段3：显示完整的祝福语");
                            specialModeText.style.opacity = '1';
                        }, 1000);
                    }, 3000);
                }, 1000);
            }, 3000);
        }
        
        function submitName() {
            const userName = userNameInput.value.trim();
            
            if (userName === '飞絮滚倾尘') {
                nameInputPage.style.opacity = '0';
                
                setTimeout(() => {
                    nameInputPage.style.display = 'none';
                    fireworksPage.style.display = 'block';
                    initFireworks();
                    startSpecialEffect();
                }, 800);
            } else {
                const greetingHTML = formatGreetingText(userName);
                finalText.innerHTML = greetingHTML;
                finalText.style.opacity = '1';
                
                specialText1.style.opacity = '0';
                specialText2.style.opacity = '0';
                specialModeText.style.opacity = '0';
                
                nameInputPage.style.opacity = '0';
                
                setTimeout(() => {
                    nameInputPage.style.display = 'none';
                    fireworksPage.style.display = 'block';
                    initFireworks();
                }, 800);
            }
        }
        
        submitNameBtn.addEventListener('click', submitName);
        userNameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitName();
            }
        });
        
        function initFireworks() {
            const canvas = document.getElementById('fireworksCanvas');
            const ctx = canvas.getContext('2d');
            const bgMusic = document.getElementById('bgMusic');
            
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            let fireworks = [];
            let particles = [];
            let autoFireInterval;
            let isAutoFiring = false;
            let lastFireworkTime = 0;
            let frameCount = 0;
            
            // 修改：帧率锁定为20fps
            let fps = 20; // 从30降低到20
            let interval = 1000 / fps; // 每帧间隔时间(毫秒) - 从33.33ms增加到50ms
            let lastTime = 0; // 上一帧的时间
            let timer = 0; // 累积时间
            
            let audioContext;
            let masterGainNode;
            let isAudioContextInitialized = false;
            
            let isMusicPlaying = false;
            let isMusicMuted = false;
            let musicVolume = 0.6;
            
            // 减少粒子数量
            const PARTICLE_COUNT = 70;
            
            // 修改：降低重力和风力，使空中速度变慢
            const GRAVITY = 0.035; // 从0.07降低一半到0.035
            const EXPLOSION_HEIGHT_RATIO = 0.55;
            const WIND = 0.006; // 从0.012降低一半到0.006
            
            // 颜色预设
            const COLOR_PRESETS = [
                // 单色预设
                {hue: 0, saturation: 100, lightness: 70, type: 'single'},
                {hue: 30, saturation: 100, lightness: 70, type: 'single'},
                {hue: 60, saturation: 100, lightness: 70, type: 'single'},
                {hue: 120, saturation: 100, lightness: 70, type: 'single'},
                {hue: 180, saturation: 100, lightness: 70, type: 'single'},
                {hue: 240, saturation: 100, lightness: 70, type: 'single'},
                {hue: 280, saturation: 100, lightness: 70, type: 'single'},
                {hue: 330, saturation: 100, lightness: 70, type: 'single'},
                {hue: 45, saturation: 100, lightness: 70, type: 'single'},
                {hue: 300, saturation: 100, lightness: 70, type: 'single'},
                
                // 两百色预设
                {hue: 0, saturation: 100, lightness: 70, hue2: 240, type: 'double'},
                {hue: 120, saturation: 100, lightness: 70, hue2: 60, type: 'double'},
                {hue: 180, saturation: 100, lightness: 70, hue2: 330, type: 'double'},
                {hue: 30, saturation: 100, lightness: 70, hue2: 280, type: 'double'},
                {hue: 240, saturation: 100, lightness: 70, hue2: 120, type: 'double'},
                {hue: 0, saturation: 100, lightness: 70, hue2: 120, type: 'double'},
                {hue: 280, saturation: 100, lightness: 70, hue2: 60, type: 'double'},
                {hue: 330, saturation: 100, lightness: 70, hue2: 180, type: 'double'},
                {hue: 45, saturation: 100, lightness: 70, hue2: 240, type: 'double'},
                {hue: 60, saturation: 100, lightness: 70, hue2: 330, type: 'double'},
            ];
            
            const EXPLOSION_PATTERNS = {
                NORMAL: 'normal',
                RING: 'ring',
                SPIRAL: 'spiral',
                STAR: 'star',
                HEART: 'heart',
                RANDOM_DIRECTION: 'random_direction',
                CONCENTRIC: 'concentric',
                TWISTER: 'twister',
                WAVE: 'wave',
                CLUSTER: 'cluster',
                MULTI_EXPLOSION: 'multi_explosion',
                CASCADE: 'cascade',
                SEQUENTIAL: 'sequential'
            };
            
            function initAudioSystem() {
                if (isAudioContextInitialized) return;
                
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    masterGainNode = audioContext.createGain();
                    masterGainNode.connect(audioContext.destination);
                    masterGainNode.gain.value = 0.4;
                    
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    
                    isAudioContextInitialized = true;
                } catch (error) {
                    console.log("音效系统初始化失败");
                }
            }
            
            function playFireworkLaunchSound() {
                if (!isAudioContextInitialized) {
                    initAudioSystem();
                    if (!isAudioContextInitialized) return;
                }
                
                try {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(masterGainNode);
                    
                    oscillator.type = 'sine';
                    // 降低音调，配合较慢的发射速度
                    oscillator.frequency.setValueAtTime(350, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(650, audioContext.currentTime + 0.35);
                    
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.45);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.45);
                } catch (error) {}
            }
            
            function initMusic() {
                bgMusic.volume = musicVolume;
                
                bgMusic.addEventListener('canplay', function() {
                    console.log('音乐可以播放');
                });
                
                bgMusic.addEventListener('error', function(e) {
                    console.log('音乐加载失败:', e);
                });
                
                bgMusic.addEventListener('playing', function() {
                    isMusicPlaying = true;
                });
                
                bgMusic.addEventListener('pause', function() {
                    isMusicPlaying = false;
                });
                
                setTimeout(() => {
                    playMusic();
                }, 1000);
            }
            
            function playMusic() {
                if (isMusicPlaying) return;
                
                const playPromise = bgMusic.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        isMusicPlaying = true;
                        bgMusic.muted = false;
                        isMusicMuted = false;
                    }).catch(error => {
                        console.log('自动播放被阻止，等待用户交互');
                    });
                }
            }
            
            function random(min, max) {
                return Math.random() * (max - min) + min;
            }
            
            function randomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
            
            function getRandomExplosionPattern(isMultiExplosion = false) {
                const patterns = Object.values(EXPLOSION_PATTERNS);
                
                if (isMultiExplosion) {
                    const multiExplosionPatterns = [
                        EXPLOSION_PATTERNS.MULTI_EXPLOSION,
                        EXPLOSION_PATTERNS.CASCADE,
                        EXPLOSION_PATTERNS.SEQUENTIAL,
                        EXPLOSION_PATTERNS.CLUSTER,
                        EXPLOSION_PATTERNS.TWISTER
                    ];
                    return multiExplosionPatterns[randomInt(0, multiExplosionPatterns.length - 1)];
                }
                
                const weightedPatterns = [];
                for (let i = 0; i < 3; i++) weightedPatterns.push(EXPLOSION_PATTERNS.NORMAL);
                for (let i = 0; i < 2; i++) weightedPatterns.push(EXPLOSION_PATTERNS.RING);
                for (let i = 0; i < 2; i++) weightedPatterns.push(EXPLOSION_PATTERNS.SPIRAL);
                for (let i = 0; i < 1; i++) weightedPatterns.push(EXPLOSION_PATTERNS.STAR);
                for (let i = 0; i < 1; i++) weightedPatterns.push(EXPLOSION_PATTERNS.HEART);
                for (let i = 0; i < 2; i++) weightedPatterns.push(EXPLOSION_PATTERNS.RANDOM_DIRECTION);
                for (let i = 0; i < 2; i++) weightedPatterns.push(EXPLOSION_PATTERNS.CONCENTRIC);
                for (let i = 0; i < 1; i++) weightedPatterns.push(EXPLOSION_PATTERNS.TWISTER);
                for (let i = 0; i < 1; i++) weightedPatterns.push(EXPLOSION_PATTERNS.WAVE);
                for (let i = 0; i < 1; i++) weightedPatterns.push(EXPLOSION_PATTERNS.CLUSTER);
                
                return weightedPatterns[randomInt(0, weightedPatterns.length - 1)];
            }
            
            function getRandomColorConfig() {
                if (Math.random() < 0.3) {
                    const doubleColorPresets = COLOR_PRESETS.filter(c => c.type === 'double');
                    return doubleColorPresets[randomInt(0, doubleColorPresets.length - 1)];
                } else {
                    const singleColorPresets = COLOR_PRESETS.filter(c => c.type === 'single');
                    return singleColorPresets[randomInt(0, singleColorPresets.length - 1)];
                }
            }
            
            class EnhancedParticle {
                constructor(x, y, colorConfig, explosionPower = 1, explosionPattern = EXPLOSION_PATTERNS.NORMAL) {
                    this.x = x;
                    this.y = y;
                    this.size = random(0.8, 2.2);
                    this.colorConfig = colorConfig;
                    this.explosionPower = explosionPower;
                    this.explosionPattern = explosionPattern;
                    
                    let speed, angle;
                    
                    switch(explosionPattern) {
                        case EXPLOSION_PATTERNS.RING:
                            angle = random(0, Math.PI * 2);
                            // 修改：粒子爆炸速度降低一半
                            speed = random(2.75, 4.5) * explosionPower * 0.9; // 从5.5-9降低到2.75-4.5
                            break;
                            
                        case EXPLOSION_PATTERNS.SPIRAL:
                            angle = random(0, Math.PI * 2);
                            speed = random(1.75, 5.5) * explosionPower * 0.9; // 从3.5-11降低到1.75-5.5
                            this.spiralFactor = random(0.04, 0.125); // 螺旋因子也减半
                            this.spiralAngle = angle;
                            break;
                            
                        case EXPLOSION_PATTERNS.STAR:
                            const starAngles = [0, 72, 144, 216, 288].map(a => a * Math.PI / 180);
                            angle = starAngles[randomInt(0, 4)] + random(-0.25, 0.25);
                            speed = random(2.25, 6.75) * explosionPower * 0.9; // 从4.5-13.5降低到2.25-6.75
                            break;
                            
                        case EXPLOSION_PATTERNS.HEART:
                            angle = random(0, Math.PI * 2);
                            const t = angle;
                            const heartFactor = Math.sin(t) * Math.sqrt(Math.abs(Math.cos(t))) / (Math.sin(t) + 7/5) - 2*Math.sin(t) + 2;
                            speed = random(1.75, 3.75) * explosionPower * Math.abs(heartFactor) * 0.9; // 从3.5-7.5降低到1.75-3.75
                            break;
                            
                        case EXPLOSION_PATTERNS.RANDOM_DIRECTION:
                            angle = random(0, Math.PI * 2);
                            const directionBias = random(0.4, 2.2);
                            speed = random(1.25, 5.5) * explosionPower * directionBias * 0.9; // 从2.5-11降低到1.25-5.5
                            break;
                            
                        case EXPLOSION_PATTERNS.CONCENTRIC:
                            angle = random(0, Math.PI * 2);
                            const distance = random(0.4, 2.2);
                            speed = random(1.75, 4.25) * explosionPower * distance * 0.9; // 从3.5-8.5降低到1.75-4.25
                            break;
                            
                        case EXPLOSION_PATTERNS.TWISTER:
                            angle = random(0, Math.PI * 2);
                            speed = random(1, 4.5) * explosionPower * 0.9; // 从2-9降低到1-4.5
                            this.twisterFactor = random(0.075, 0.175); // 龙卷风因子减半
                            this.twisterAngle = angle;
                            break;
                            
                        case EXPLOSION_PATTERNS.WAVE:
                            angle = random(0, Math.PI * 2);
                            speed = random(1.5, 5) * explosionPower * 0.9; // 从3-10降低到1.5-5
                            this.waveFrequency = random(0.05, 0.15); // 波浪频率减半
                            this.waveAmplitude = random(0.5, 1.5);
                            break;
                            
                        case EXPLOSION_PATTERNS.CLUSTER:
                            angle = random(0, Math.PI * 2);
                            speed = random(1, 4) * explosionPower * 0.9; // 从2-8降低到1-4
                            this.clusterOffset = random(0, Math.PI * 2);
                            break;
                            
                        case EXPLOSION_PATTERNS.MULTI_EXPLOSION:
                        case EXPLOSION_PATTERNS.CASCADE:
                        case EXPLOSION_PATTERNS.SEQUENTIAL:
                            angle = random(0, Math.PI * 2);
                            speed = random(1.5, 5) * explosionPower * 0.9; // 从3-10降低到1.5-5
                            this.multiExplosionIndex = 0;
                            break;
                            
                        default:
                            angle = random(0, Math.PI * 2);
                            speed = random(1.75, 5.5) * explosionPower * 0.9; // 从3.5-11降低到1.75-5.5
                            break;
                    }
                    
                    this.vx = Math.cos(angle) * speed;
                    this.vy = Math.sin(angle) * speed;
                    this.drag = random(0.93, 0.97);
                    this.life = 1.0;
                    this.decay = random(0.008, 0.025);
                    this.hasGlow = Math.random() > 0.75;
                    this.originalAngle = angle;
                    this.originalSpeed = speed;
                    
                    if (colorConfig.type === 'double') {
                        this.useSecondColor = Math.random() > 0.5;
                        this.hue = this.useSecondColor ? colorConfig.hue2 : colorConfig.hue;
                    } else {
                        this.hue = colorConfig.hue;
                    }
                    
                    this.hueVariation = random(-15, 15);
                    this.saturationVariation = random(-10, 10);
                }
                
                update() {
                    switch(this.explosionPattern) {
                        case EXPLOSION_PATTERNS.SPIRAL:
                            this.spiralAngle += this.spiralFactor;
                            const spiralRadius = 1 + Math.sin(Date.now() * 0.008) * 0.25;
                            this.vx = Math.cos(this.spiralAngle) * this.originalSpeed * spiralRadius;
                            this.vy = Math.sin(this.spiralAngle) * this.originalSpeed * spiralRadius;
                            break;
                            
                        case EXPLOSION_PATTERNS.TWISTER:
                            this.twisterAngle += this.twisterFactor;
                            const twisterRadius = 1 + Math.cos(Date.now() * 0.01 + this.twisterAngle) * 0.4;
                            this.vx = Math.cos(this.twisterAngle) * this.originalSpeed * twisterRadius;
                            this.vy = Math.sin(this.twisterAngle) * this.originalSpeed * twisterRadius;
                            break;
                            
                        case EXPLOSION_PATTERNS.WAVE:
                            const waveOffset = Math.sin(Date.now() * 0.01 * this.waveFrequency + this.originalAngle) * this.waveAmplitude;
                            this.vx = Math.cos(this.originalAngle + waveOffset) * this.originalSpeed;
                            this.vy = Math.sin(this.originalAngle + waveOffset) * this.originalSpeed;
                            break;
                            
                        case EXPLOSION_PATTERNS.CLUSTER:
                            const clusterTime = Date.now() * 0.005 + this.clusterOffset;
                            const clusterFactor = 0.7 + 0.3 * Math.sin(clusterTime);
                            this.vx = Math.cos(this.originalAngle) * this.originalSpeed * clusterFactor;
                            this.vy = Math.sin(this.originalAngle) * this.originalSpeed * clusterFactor;
                            break;
                    }
                    
                    this.x += this.vx;
                    this.y += this.vy;
                    this.vy += GRAVITY;
                    this.vx += WIND * random(-1.2, 1.2);
                    this.vx *= this.drag;
                    this.vy *= this.drag;
                    this.life -= this.decay;
                    
                    if (this.hasGlow && Math.random() > 0.3) {
                        this.size += Math.sin(Date.now() * 0.008 + this.originalAngle) * 0.15;
                    }
                    
                    if (Math.random() > 0.8) {
                        this.hueVariation += random(-2, 2);
                    }
                    
                    return this.life > 0 && this.y < canvas.height + 100;
                }
                
                draw() {
                    const alpha = this.life * 0.85;
                    const hue = this.hue + this.hueVariation;
                    const saturation = Math.max(60, Math.min(100, this.colorConfig.saturation + this.saturationVariation));
                    const lightness = this.colorConfig.lightness * this.life * random(0.9, 1.1);
                    
                    if (this.hasGlow) {
                        const glowSize = this.size * (1.3 + Math.sin(Date.now() * 0.01) * 0.2);
                        const gradient = ctx.createRadialGradient(
                            this.x, this.y, 0,
                            this.x, this.y, glowSize
                        );
                        gradient.addColorStop(0, `hsla(${hue}, ${saturation}%, ${lightness}%, ${alpha})`);
                        gradient.addColorStop(0.7, `hsla(${hue}, ${saturation}%, ${lightness * 0.7}%, ${alpha * 0.4})`);
                        gradient.addColorStop(1, `hsla(${hue}, ${saturation}%, ${lightness * 0.3}%, 0)`);
                        
                        ctx.fillStyle = gradient;
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, glowSize, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    ctx.fillStyle = `hsla(${hue}, ${saturation}%, ${lightness}%, ${alpha})`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                    
                    if (this.life > 0.7) {
                        ctx.strokeStyle = `hsla(${hue}, ${saturation}%, ${lightness}%, ${alpha * 0.3})`;
                        ctx.lineWidth = 0.8;
                        ctx.beginPath();
                        ctx.moveTo(this.x, this.y);
                        ctx.lineTo(this.x - this.vx * 0.6, this.y - this.vy * 0.6);
                        ctx.stroke();
                    }
                }
            }
            
            class EnhancedFirework {
                constructor(x, targetY, colorConfig, size = 'large', isMultiExplosion = false) {
                    this.x = x;
                    this.y = canvas.height;
                    this.targetY = targetY;
                    this.colorConfig = colorConfig;
                    this.size = size;
                    this.isMultiExplosion = isMultiExplosion;
                    
                    // 修改：发射速度降低一半 (从9-16降低到4.5-8)
                    this.speed = random(4.5, 8);
                    
                    this.exploded = false;
                    this.trail = [];
                    this.explosionPower = random(0.6, 2.0);
                    
                    if (isMultiExplosion) {
                        this.explosionPattern = getRandomExplosionPattern(true);
                        this.explosionPower = random(1.2, 2.5);
                        this.multiExplosionCount = randomInt(3, 6);
                    } else {
                        this.explosionPattern = getRandomExplosionPattern(false);
                    }
                    
                    playFireworkLaunchSound();
                }
                
                update() {
                    if (!this.exploded) {
                        this.trail.push({x: this.x, y: this.y, life: 1.0});
                        
                        // 以较慢的速度上升
                        this.y -= this.speed;
                        
                        if (this.y <= this.targetY) {
                            this.explode();
                            return false;
                        }
                        
                        return true;
                    }
                    
                    return false;
                }
                
                explode() {
                    this.exploded = true;
                    
                    let particleCount;
                    switch(this.size) {
                        case 'xlarge':
                            particleCount = randomInt(80, 120);
                            break;
                        case 'large':
                            particleCount = randomInt(60, 90);
                            break;
                        default:
                            particleCount = randomInt(35, 60);
                    }
                    
                    if (this.isMultiExplosion) {
                        this.createMultiExplosion(particleCount);
                    } else {
                        this.createNormalExplosion(particleCount);
                    }
                }
                
                createNormalExplosion(particleCount) {
                    const useMixedPattern = Math.random() > 0.7;
                    
                    for (let i = 0; i < particleCount; i++) {
                        let pattern = this.explosionPattern;
                        if (useMixedPattern && i > particleCount * 0.3) {
                            pattern = getRandomExplosionPattern(false);
                        }
                        
                        particles.push(new EnhancedParticle(
                            this.x + random(-10, 10),
                            this.y + random(-10, 10),
                            this.colorConfig,
                            this.explosionPower * random(0.8, 1.2),
                            pattern
                        ));
                    }
                    
                    if (Math.random() < 0.3) {
                        const secondDelay = random(100, 400);
                        setTimeout(() => {
                            const secondPattern = getRandomExplosionPattern(false);
                            const secondPower = random(0.4, 1.2);
                            const secondCount = Math.floor(particleCount * random(0.2, 0.4));
                            
                            for (let i = 0; i < secondCount; i++) {
                                particles.push(new EnhancedParticle(
                                    this.x + random(-30, 30),
                                    this.y + random(-30, 30),
                                    this.colorConfig,
                                    secondPower,
                                    secondPattern
                                ));
                            }
                        }, secondDelay);
                    }
                }
                
                createMultiExplosion(baseParticleCount) {
                    const explosionCount = this.multiExplosionCount;
                    const explosionDelay = random(80, 200);
                    
                    for (let i = 0; i < explosionCount; i++) {
                        setTimeout(() => {
                            const pattern = getRandomExplosionPattern(true);
                            const power = this.explosionPower * (0.8 - i * 0.15);
                            const count = Math.floor(baseParticleCount * (0.6 - i * 0.1));
                            
                            const offsetX = this.x + random(-40, 40) * i;
                            const offsetY = this.y + random(-40, 40) * i;
                            
                            for (let j = 0; j < count; j++) {
                                particles.push(new EnhancedParticle(
                                    offsetX + random(-15, 15),
                                    offsetY + random(-15, 15),
                                    this.colorConfig,
                                    power,
                                    pattern
                                ));
                            }
                            
                            if (Math.random() < 0.4 && i < explosionCount - 1) {
                                setTimeout(() => {
                                    const miniCount = Math.floor(count * 0.3);
                                    for (let k = 0; k < miniCount; k++) {
                                        particles.push(new EnhancedParticle(
                                            offsetX + random(-60, 60),
                                            offsetY + random(-60, 60),
                                            this.colorConfig,
                                            power * 0.5,
                                            getRandomExplosionPattern(false)
                                        ));
                                    }
                                }, random(50, 150));
                            }
                        }, i * explosionDelay);
                    }
                    
                    setTimeout(() => {
                        const finalCount = Math.floor(baseParticleCount * 1.5);
                        for (let i = 0; i < finalCount; i++) {
                            particles.push(new EnhancedParticle(
                                this.x + random(-50, 50),
                                this.y + random(-50, 50),
                                this.colorConfig,
                                this.explosionPower * 0.7,
                                getRandomExplosionPattern(true)
                            ));
                        }
                    }, explosionCount * explosionDelay + 100);
                }
                
                draw() {
                    if (!this.exploded) {
                        // 绘制轨迹 - 修改：从金色改为白色
                        for (let i = 0; i < this.trail.length; i++) {
                            const point = this.trail[i];
                            point.life -= 0.045;
                            
                            if (point.life > 0) {
                                const trailSize = 2.5 * (i / this.trail.length);
                                // 修改：金色改为白色 (hsl(0, 0%, 100%))
                                ctx.fillStyle = `hsla(0, 0%, 100%, ${point.life * 0.8})`;
                                ctx.beginPath();
                                ctx.arc(point.x, point.y, trailSize, 0, Math.PI * 2);
                                ctx.fill();
                            }
                        }
                        
                        // 绘制烟花主体 - 修改：从金色光改为白色光
                        const gradient = ctx.createRadialGradient(
                            this.x, this.y, 0,
                            this.x, this.y, 7
                        );
                        // 修改：金色改为白色
                        gradient.addColorStop(0, 'hsla(0, 0%, 100%, 1)');
                        gradient.addColorStop(1, 'hsla(0, 0%, 90%, 0.8)');
                        
                        ctx.fillStyle = gradient;
                        ctx.shadowColor = 'hsla(0, 0%, 100%, 0.9)'; // 阴影也改为白色
                        ctx.shadowBlur = 12;
                        
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, 4.5, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.shadowBlur = 0;
                    }
                }
            }
            
            function createRandomFirework() {
                const x = random(50, canvas.width - 50);
                const targetY = random(canvas.height * 0.25, canvas.height * EXPLOSION_HEIGHT_RATIO);
                const colorConfig = getRandomColorConfig();
                
                const rand = Math.random();
                let size = 'medium';
                if (rand > 0.85) {
                    size = 'xlarge';
                } else if (rand > 0.6) {
                    size = 'large';
                }
                
                const isMultiExplosion = Math.random() < 0.15;
                
                fireworks.push(new EnhancedFirework(x, targetY, colorConfig, size, isMultiExplosion));
            }
            
            function createSpecialFirework() {
                const x = random(120, canvas.width - 120);
                const targetY = random(canvas.height * 0.18, canvas.height * 0.32);
                const colorConfig = getRandomColorConfig();
                
                const isMultiExplosion = Math.random() < 0.4;
                const size = isMultiExplosion ? 'xlarge' : 'large';
                
                const specialFirework = new EnhancedFirework(x, targetY, colorConfig, size, isMultiExplosion);
                if (!isMultiExplosion) {
                    specialFirework.explosionPower = random(1.4, 2.3);
                }
                
                fireworks.push(specialFirework);
                
                if (Math.random() < 0.2) {
                    setTimeout(() => {
                        const pairedFirework = new EnhancedFirework(
                            x + random(-90, 90),
                            targetY + random(-40, 40),
                            colorConfig,
                            'medium',
                            Math.random() < 0.3
                        );
                        fireworks.push(pairedFirework);
                    }, random(150, 400));
                }
            }
            
            function startAutoFire() {
                if (isAutoFiring) return;
                
                isAutoFiring = true;
                
                // 由于发射速度变慢，需要更早开始发射，否则开始时画面太空
                setTimeout(() => createRandomFirework(), 200);
                setTimeout(() => createRandomFirework(), 500);
                setTimeout(() => createSpecialFirework(), 1000);
                setTimeout(() => createRandomFirework(), 1500);
                
                autoFireInterval = setInterval(() => {
                    const now = Date.now();
                    // 由于发射速度变慢，可以稍微增加发射频率，但保持烟花总数减少
                    if (now - lastFireworkTime > 850) {
                        if (Math.random() < 0.15) {
                            createSpecialFirework();
                        } else {
                            const count = Math.random() > 0.7 ? 2 : 1;
                            for (let i = 0; i < count; i++) {
                                setTimeout(() => createRandomFirework(), i * 200);
                            }
                        }
                        lastFireworkTime = now;
                    }
                }, 850);
            }
            
            // 修改：锁定帧率为20fps的动画循环
            function animate(time) {
                // 计算时间差
                const currentTime = time || Date.now();
                const deltaTime = currentTime - lastTime;
                lastTime = currentTime;
                
                // 累积时间
                timer += deltaTime;
                
                // 当累积时间超过设定的间隔时，才执行更新和绘制
                while (timer >= interval) {
                    // 更新逻辑
                    frameCount++;
                    
                    // 清除画布
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.12)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // 更新和绘制烟花
                    for (let i = fireworks.length - 1; i >= 0; i--) {
                        const firework = fireworks[i];
                        if (!firework.update()) {
                            fireworks.splice(i, 1);
                        } else {
                            firework.draw();
                        }
                    }
                    
                    // 更新和绘制粒子
                    for (let i = particles.length - 1; i >= 0; i--) {
                        const particle = particles[i];
                        if (!particle.update()) {
                            particles.splice(i, 1);
                        } else {
                            particle.draw();
                        }
                    }
                    
                    // 限制粒子数量
                    if (particles.length > 800) {
                        particles.splice(0, particles.length - 650);
                    }
                    
                    // 减去一个间隔时间
                    timer -= interval;
                }
                
                // 继续下一帧
                requestAnimationFrame(animate);
            }
            
            canvas.addEventListener('click', function(event) {
                if (!isMusicPlaying && !isMusicMuted) {
                    playMusic();
                }
                
                initAudioSystem();
                
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const targetY = random(canvas.height * 0.18, canvas.height * 0.28);
                const colorConfig = getRandomColorConfig();
                
                const isMultiExplosion = Math.random() < 0.4;
                const clickFirework = new EnhancedFirework(x, targetY, colorConfig, 'xlarge', isMultiExplosion);
                if (!isMultiExplosion) {
                    clickFirework.explosionPower = random(1.7, 2.8);
                }
                
                fireworks.push(clickFirework);
                
                if (Math.random() < 0.3) {
                    setTimeout(() => {
                        const secondFirework = new EnhancedFirework(
                            x + random(-70, 70),
                            targetY + random(-25, 25),
                            colorConfig,
                            'large',
                            Math.random() < 0.2
                        );
                        if (!secondFirework.isMultiExplosion) {
                            secondFirework.explosionPower = random(1.1, 1.9);
                        }
                        fireworks.push(secondFirework);
                    }, 180);
                }
            });
            
            function initFireworksSystem() {
                initMusic();
                initAudioSystem();
                
                // 初始化时间变量
                lastTime = performance.now();
                
                // 启动动画循环
                requestAnimationFrame(animate);
                
                startAutoFire();
                
                canvas.addEventListener('touchstart', function(event) {
                    event.preventDefault();
                    
                    if (!isMusicPlaying && !isMusicMuted) {
                        playMusic();
                    }
                    
                    initAudioSystem();
                    
                    const touch = event.touches[0];
                    const rect = canvas.getBoundingClientRect();
                    const x = touch.clientX - rect.left;
                    const targetY = random(canvas.height * 0.22, canvas.height * 0.38);
                    const colorConfig = getRandomColorConfig();
                    
                    const touchFirework = new EnhancedFirework(x, targetY, colorConfig, 'xlarge', Math.random() < 0.3);
                    if (!touchFirework.isMultiExplosion) {
                        touchFirework.explosionPower = random(1.7, 2.8);
                    }
                    
                    fireworks.push(touchFirework);
                });
            }
            
            initFireworksSystem();
        }
        
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        document.addEventListener('keydown', function(e) {
            if ([32, 37, 38, 39, 40].indexOf(e.keyCode) > -1) {
                e.preventDefault();
            }
        }, false);
    </script>
</body>
</html>
